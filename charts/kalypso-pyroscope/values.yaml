# Pyroscope Base Configuration
# Microservices v2 deployment with S3 storage

minio:
  enabled: false

pyroscope:
  agent:
    enabled: false

  alloy:
    enabled: false

  podAnnotations:
    profiles.grafana.com/cpu.scrape: "true"
    profiles.grafana.com/cpu.port: "4040"
    profiles.grafana.com/cpu.port_name: http2
    profiles.grafana.com/memory.scrape: "false"
    profiles.grafana.com/goroutine.scrape: "false"

  extraArgs:
    storage.backend: s3

  config: |
    storage:
      backend: s3
      s3:
        endpoint: minio.minio.svc.cluster.local:9000
        bucket_name: pyroscope-data
        access_key_id: rootuser
        secret_access_key: rootpass123
        insecure: true
        signature_version: v4

  architecture:
    deployUnifiedServices: false

    microservices:
      enabled: true

      v2:
        query-backend:
          replicaCount: 1
          resources:
            limits:
              memory: 512Mi
            requests:
              memory: 128Mi
              cpu: 100m

        query-frontend:
          replicaCount: 1
          resources:
            limits:
              memory: 512Mi
            requests:
              memory: 128Mi
              cpu: 100m

        distributor:
          replicaCount: 1
          resources:
            limits:
              memory: 512Mi
            requests:
              memory: 128Mi
              cpu: 100m

        segment-writer:
          replicaCount: 1
          terminationGracePeriodSeconds: 600
          persistence:
            enabled: false
          resources:
            limits:
              memory: 2Gi
            requests:
              memory: 512Mi
              cpu: 500m

        compaction-worker:
          replicaCount: 1
          terminationGracePeriodSeconds: 1200
          resources:
            limits:
              memory: 1Gi
            requests:
              memory: 256Mi
              cpu: 500m

        metastore:
          replicaCount: 1
          terminationGracePeriodSeconds: 1200
          resources:
            limits:
              memory: 1Gi
            requests:
              memory: 256Mi
              cpu: 500m
          extraArgs:
            metastore.raft.bootstrap-expect-peers: 1
            adaptive-placement.max-dataset-shards: 512
            adaptive-placement.unit-size-bytes: 131072
            metastore.index.cleanup-interval: 1m
            metastore.snapshot-compact-on-restore: true

        tenant-settings:
          replicaCount: 1
          resources:
            limits:
              memory: 256Mi
            requests:
              memory: 64Mi
              cpu: 100m

        ad-hoc-profiles:
          replicaCount: 1
          resources:
            limits:
              memory: 256Mi
            requests:
              memory: 64Mi
              cpu: 100m

        admin:
          replicaCount: 1
          resources:
            limits:
              memory: 256Mi
            requests:
              memory: 64Mi
              cpu: 100m

    storage:
      v1: false
      v2: true

      migration:
        ingesterWeight: 0.0
        segmentWriterWeight: 1.0

  serviceMonitor:
    enabled: false

  serviceAccount:
    name: pyroscope

ebpfProfiler:
  enabled: true
  image: "ebpf-profiler:latest"
  # OTel Collector endpoint for sending profiles
  collectorEndpoint: "kalypso-otel-collector.otel-system.svc.cluster.local:4317"

otelCollector:
  enabled: false
