# Kalypso Pyroscope Configuration
# Using Pyroscope Helm Chart v1.18.0
# Microservices mode with external MinIO storage

# Disable built-in MinIO (using kalypso-minio instead)
minio:
  enabled: false

# Disable Grafana Agent (deprecated)
agent:
  enabled: false

# Disable Alloy (using external OTel if needed)
alloy:
  enabled: false

# Main Pyroscope configuration
pyroscope:
  # Storage configuration using structuredConfig
  structuredConfig:
    storage:
      backend: s3
      s3:
        endpoint: kalypso-minio.minio.svc.cluster.local:9000
        bucket_name: pyroscope-data
        access_key_id: rootuser
        secret_access_key: rootpass123
        insecure: true

  # Extra arguments for Pyroscope
  extraArgs:
    log.level: info

  # Microservices mode - define components
  # Using minimal resources for local/dev deployment
  components:
    querier:
      kind: Deployment
      replicaCount: 1
      resources:
        limits:
          memory: 512Mi
        requests:
          memory: 128Mi
          cpu: 100m

    query-frontend:
      kind: Deployment
      replicaCount: 1
      resources:
        limits:
          memory: 512Mi
        requests:
          memory: 128Mi
          cpu: 100m

    query-scheduler:
      kind: Deployment
      replicaCount: 1
      resources:
        limits:
          memory: 512Mi
        requests:
          memory: 128Mi
          cpu: 100m

    distributor:
      kind: Deployment
      replicaCount: 1
      resources:
        limits:
          memory: 512Mi
        requests:
          memory: 128Mi
          cpu: 100m

    ingester:
      kind: Deployment
      replicaCount: 1
      resources:
        limits:
          memory: 1Gi
        requests:
          memory: 256Mi
          cpu: 200m

    compactor:
      kind: Deployment
      replicaCount: 1
      resources:
        limits:
          memory: 1Gi
        requests:
          memory: 256Mi
          cpu: 200m

    store-gateway:
      kind: Deployment
      replicaCount: 1
      resources:
        limits:
          memory: 1Gi
        requests:
          memory: 256Mi
          cpu: 200m

  # Pod annotations for self-profiling
  podAnnotations:
    profiles.grafana.com/cpu.scrape: "true"
    profiles.grafana.com/cpu.port_name: http2
    profiles.grafana.com/memory.scrape: "true"
    profiles.grafana.com/memory.port_name: http2
    profiles.grafana.com/goroutine.scrape: "true"
    profiles.grafana.com/goroutine.port_name: http2

  # Service configuration
  service:
    type: ClusterIP
    port: 4040

  # Disable ServiceMonitor (no Prometheus Operator)
  serviceMonitor:
    enabled: false

# eBPF Profiler has been moved to kalypso-otel chart
# See: charts/kalypso-otel (opentelemetry-ebpf-instrumentation dependency)
