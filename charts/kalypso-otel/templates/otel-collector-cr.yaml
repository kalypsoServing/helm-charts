{{- if .Values.otelCollector.enabled }}
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: {{ include "kalypso-otel.fullname" . }}
  labels:
    {{- include "kalypso-otel.labels" . | nindent 4 }}
spec:
  mode: deployment
  replicas: {{ .Values.otelCollector.replicas | default 1 }}
  serviceAccount: {{ include "kalypso-otel.fullname" . }}-collector
  
  {{- with .Values.otelCollector.resources }}
  resources:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  
  {{- if .Values.otelCollector.podDisruptionBudget }}
  podDisruptionBudget:
    {{- toYaml .Values.otelCollector.podDisruptionBudget | nindent 4 }}
  {{- end }}

  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
            include_metadata: true
          http:
            endpoint: 0.0.0.0:4318
            include_metadata: true

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024
      
      memory_limiter:
        check_interval: 1s
        limit_mib: {{ .Values.otelCollector.memoryLimitMiB | default 512 }}
        spike_limit_mib: {{ .Values.otelCollector.spikeLimitMiB | default 128 }}
      
      resource:
        attributes:
          - key: k8s.cluster.name
            value: {{ .Values.clusterName | default "kalypso" }}
            action: upsert
      
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        extract:
          metadata:
            - k8s.pod.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.pod.start_time
            - k8s.deployment.name
            - k8s.replicaset.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.job.name
            - k8s.cronjob.name
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: connection

    exporters:
      debug:
        verbosity: basic
      
      otlphttp/mimir:
        endpoint: {{ .Values.endpoints.mimir }}
        tls:
          insecure: true
      
      otlp/tempo:
        endpoint: {{ .Values.endpoints.tempo }}
        tls:
          insecure: true
      
      loki:
        endpoint: {{ .Values.endpoints.loki }}
        tls:
          insecure: true
      
      otlphttp/pyroscope:
        endpoint: {{ .Values.endpoints.pyroscope }}
        tls:
          insecure: true

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    service:
      extensions: [health_check]
      pipelines:
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch, resource]
          exporters: [otlphttp/mimir]
        
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch, resource]
          exporters: [otlp/tempo]
        
        logs:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch, resource]
          exporters: [loki]
        
        profiles:
          receivers: [otlp]
          processors: [memory_limiter, resource]
          exporters: [otlphttp/pyroscope]
{{- end }}
