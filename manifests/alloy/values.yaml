# Grafana Alloy - 프로파일링 전용 수집기
# Pyroscope SDK push 수신 + annotation 기반 pprof 스크래핑
# 기본 config는 Pyroscope Helm chart의 configmap-alloy.yaml 패턴을 따름

alloy:
  configMap:
    create: true
    content: |-
      logging {
        level  = "info"
        format = "logfmt"
      }

      livedebugging {
        enabled = true
      }

      // =============================================
      // Pyroscope Write — Pyroscope Distributor로 전달
      // =============================================
      pyroscope.write "default" {
        endpoint {
          url = "http://pyroscope-distributor.pyroscope.svc.cluster.local:4040"
        }
      }

      // =============================================
      // Pyroscope Receive HTTP — SDK push 수신 (port 4040)
      // =============================================
      pyroscope.receive_http "default" {
        http {
          listen_address = "0.0.0.0"
          listen_port    = 4040
        }
        forward_to = [pyroscope.write.default.receiver]
      }

      // =============================================
      // Kubernetes Discovery
      // =============================================
      discovery.kubernetes "pods" {
        role = "pod"
      }

      // =============================================
      // 공통 Relabel — annotation 라벨 추출
      // =============================================
      discovery.relabel "kubernetes_pods" {
        targets = concat(discovery.kubernetes.pods.targets)

        rule {
          action        = "drop"
          source_labels = ["__meta_kubernetes_pod_phase"]
          regex         = "Pending|Succeeded|Failed|Completed"
        }

        rule {
          action = "labelmap"
          regex  = "__meta_kubernetes_pod_label_(.+)"
        }

        rule {
          action        = "replace"
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        rule {
          action        = "replace"
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        rule {
          action        = "replace"
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
      }

      // =============================================
      // Memory profiling
      // =============================================
      discovery.relabel "kubernetes_pods_memory_default_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_port_name"]
          action        = "keep"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_number"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_port"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      discovery.relabel "kubernetes_pods_memory_custom_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_port_name"]
          action        = "drop"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_name"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_port_name"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_memory_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      pyroscope.scrape "pyroscope_scrape_memory" {
        clustering {
          enabled = true
        }

        targets    = concat(discovery.relabel.kubernetes_pods_memory_default_name.output, discovery.relabel.kubernetes_pods_memory_custom_name.output)
        forward_to = [pyroscope.write.default.receiver]

        profiling_config {
          profile.memory {
            enabled = true
          }
          profile.process_cpu {
            enabled = false
          }
          profile.goroutine {
            enabled = false
          }
          profile.block {
            enabled = false
          }
          profile.mutex {
            enabled = false
          }
          profile.fgprof {
            enabled = false
          }
        }
      }

      // =============================================
      // CPU profiling
      // =============================================
      discovery.relabel "kubernetes_pods_cpu_default_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_port_name"]
          action        = "keep"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_number"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_port"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      discovery.relabel "kubernetes_pods_cpu_custom_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_port_name"]
          action        = "drop"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_name"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_port_name"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_cpu_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      pyroscope.scrape "pyroscope_scrape_cpu" {
        clustering {
          enabled = true
        }

        targets    = concat(discovery.relabel.kubernetes_pods_cpu_default_name.output, discovery.relabel.kubernetes_pods_cpu_custom_name.output)
        forward_to = [pyroscope.write.default.receiver]

        profiling_config {
          profile.process_cpu {
            enabled = true
          }
          profile.memory {
            enabled = false
          }
          profile.goroutine {
            enabled = false
          }
          profile.block {
            enabled = false
          }
          profile.mutex {
            enabled = false
          }
          profile.fgprof {
            enabled = false
          }
        }
      }

      // =============================================
      // Goroutine profiling
      // =============================================
      discovery.relabel "kubernetes_pods_goroutine_default_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_port_name"]
          action        = "keep"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_number"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_port"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      discovery.relabel "kubernetes_pods_goroutine_custom_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_port_name"]
          action        = "drop"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_name"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_port_name"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_goroutine_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      pyroscope.scrape "pyroscope_scrape_goroutine" {
        clustering {
          enabled = true
        }

        targets    = concat(discovery.relabel.kubernetes_pods_goroutine_default_name.output, discovery.relabel.kubernetes_pods_goroutine_custom_name.output)
        forward_to = [pyroscope.write.default.receiver]

        profiling_config {
          profile.goroutine {
            enabled = true
          }
          profile.process_cpu {
            enabled = false
          }
          profile.memory {
            enabled = false
          }
          profile.block {
            enabled = false
          }
          profile.mutex {
            enabled = false
          }
          profile.fgprof {
            enabled = false
          }
        }
      }

      // =============================================
      // Block profiling
      // =============================================
      discovery.relabel "kubernetes_pods_block_default_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_port_name"]
          action        = "keep"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_number"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_block_port"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_block_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      discovery.relabel "kubernetes_pods_block_custom_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_port_name"]
          action        = "drop"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_name"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_block_port_name"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_block_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_block_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      pyroscope.scrape "pyroscope_scrape_block" {
        clustering {
          enabled = true
        }

        targets    = concat(discovery.relabel.kubernetes_pods_block_default_name.output, discovery.relabel.kubernetes_pods_block_custom_name.output)
        forward_to = [pyroscope.write.default.receiver]

        profiling_config {
          profile.block {
            enabled = true
          }
          profile.process_cpu {
            enabled = false
          }
          profile.memory {
            enabled = false
          }
          profile.goroutine {
            enabled = false
          }
          profile.mutex {
            enabled = false
          }
          profile.fgprof {
            enabled = false
          }
        }
      }

      // =============================================
      // Mutex profiling
      // =============================================
      discovery.relabel "kubernetes_pods_mutex_default_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_port_name"]
          action        = "keep"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_number"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_port"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      discovery.relabel "kubernetes_pods_mutex_custom_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_port_name"]
          action        = "drop"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_name"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_port_name"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_mutex_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      pyroscope.scrape "pyroscope_scrape_mutex" {
        clustering {
          enabled = true
        }

        targets    = concat(discovery.relabel.kubernetes_pods_mutex_default_name.output, discovery.relabel.kubernetes_pods_mutex_custom_name.output)
        forward_to = [pyroscope.write.default.receiver]

        profiling_config {
          profile.mutex {
            enabled = true
          }
          profile.process_cpu {
            enabled = false
          }
          profile.memory {
            enabled = false
          }
          profile.goroutine {
            enabled = false
          }
          profile.block {
            enabled = false
          }
          profile.fgprof {
            enabled = false
          }
        }
      }

      // =============================================
      // fgprof profiling
      // =============================================
      discovery.relabel "kubernetes_pods_fgprof_default_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_port_name"]
          action        = "keep"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_number"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_port"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      discovery.relabel "kubernetes_pods_fgprof_custom_name" {
        targets = concat(discovery.relabel.kubernetes_pods.output)

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_scrape"]
          action        = "keep"
          regex         = "true"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_port_name"]
          action        = "drop"
          regex         = ""
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_port_name"]
          target_label  = "__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_port_name"
          action        = "keepequal"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_scheme"]
          action        = "replace"
          regex         = "(https?)"
          target_label  = "__scheme__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_path"]
          action        = "replace"
          regex         = "(.+)"
          target_label  = "__profile_path__"
          replacement   = "$1"
        }

        rule {
          source_labels = ["__address__", "__meta_kubernetes_pod_annotation_profiles_grafana_com_fgprof_port"]
          action        = "replace"
          regex         = "(.+?)(?::\\d+)?;(\\d+)"
          target_label  = "__address__"
          replacement   = "$1:$2"
        }
      }

      pyroscope.scrape "pyroscope_scrape_fgprof" {
        clustering {
          enabled = true
        }

        targets    = concat(discovery.relabel.kubernetes_pods_fgprof_default_name.output, discovery.relabel.kubernetes_pods_fgprof_custom_name.output)
        forward_to = [pyroscope.write.default.receiver]

        profiling_config {
          profile.fgprof {
            enabled = true
          }
          profile.process_cpu {
            enabled = false
          }
          profile.memory {
            enabled = false
          }
          profile.goroutine {
            enabled = false
          }
          profile.block {
            enabled = false
          }
          profile.mutex {
            enabled = false
          }
        }
      }

  clustering:
    enabled: true

  extraPorts:
    - name: pyroscope-rx
      port: 4040
      targetPort: 4040
      protocol: TCP

# Controller 설정 — Deployment 모드, 2 replicas
controller:
  type: deployment
  replicas: 2

# RBAC — alloy-rbac.yaml에서 직접 관리 (크로스 네임스페이스 디스커버리)
rbac:
  create: false

# ServiceAccount — Helm chart가 생성 (ClusterRoleBinding에서 참조)
serviceAccount:
  create: true
  name: alloy
