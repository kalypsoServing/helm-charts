apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: pyroscope

helmCharts:
  - name: pyroscope
    repo: https://grafana.github.io/helm-charts
    version: 1.18.0
    releaseName: pyroscope
    namespace: pyroscope
    valuesInline:
      minio:
        enabled: false
      agent:
        enabled: false
      alloy:
        enabled: false
      pyroscope:
        structuredConfig:
          storage:
            backend: s3
            s3:
              endpoint: kalypso-minio.minio.svc.cluster.local:9000
              bucket_name: pyroscope-data
              access_key_id: rootuser
              secret_access_key: rootpass123
              insecure: true
        extraArgs:
          log.level: info
        components:
          querier:
            kind: Deployment
            replicaCount: 1
            resources:
              limits:
                memory: 512Mi
              requests:
                memory: 128Mi
                cpu: 100m
          query-frontend:
            kind: Deployment
            replicaCount: 1
            resources:
              limits:
                memory: 512Mi
              requests:
                memory: 128Mi
                cpu: 100m
          query-scheduler:
            kind: Deployment
            replicaCount: 1
            resources:
              limits:
                memory: 512Mi
              requests:
                memory: 128Mi
                cpu: 100m
          distributor:
            kind: Deployment
            replicaCount: 1
            resources:
              limits:
                memory: 512Mi
              requests:
                memory: 128Mi
                cpu: 100m
          ingester:
            kind: Deployment
            replicaCount: 1
            resources:
              limits:
                memory: 1Gi
              requests:
                memory: 256Mi
                cpu: 200m
          compactor:
            kind: Deployment
            replicaCount: 1
            resources:
              limits:
                memory: 1Gi
              requests:
                memory: 256Mi
                cpu: 200m
          store-gateway:
            kind: Deployment
            replicaCount: 1
            resources:
              limits:
                memory: 1Gi
              requests:
                memory: 256Mi
                cpu: 200m
        podAnnotations:
          profiles.grafana.com/cpu.scrape: "true"
          profiles.grafana.com/cpu.port_name: http2
          profiles.grafana.com/memory.scrape: "true"
          profiles.grafana.com/memory.port_name: http2
          profiles.grafana.com/goroutine.scrape: "true"
          profiles.grafana.com/goroutine.port_name: http2
        service:
          type: ClusterIP
          port: 4040
        serviceMonitor:
          enabled: false

resources:
  - namespace.yaml
